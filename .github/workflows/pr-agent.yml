name: PR Review Bot

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Debug Private Key
        run: |
          echo "Debugging private key..."
          echo "${{ secrets.APP_PRIVATE_KEY }}" | base64 -d | head -c 100
     
      - name: Gerar token do GitHub App
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}               # ID do GitHub App
          private_key: ${{ secrets.APP_PRIVATE_KEY }} # Chave privada do App

      - name: Checkout cÃ³digo (sem persistir o token)
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: false
          fetch-depth: 0

      - name: Disparar PRâ€‘Agent via HTTP
        env:
          REPO: https://github.com/${{ github.repository }}.git
          PR: ${{ github.event.pull_request.number }}
          TOKEN: ${{ steps.app-token.outputs.token }}
          AGENT_URL: https://teu-servidor.com/analyze
        run: |
          echo "ðŸ”” Chamando PRâ€‘Agent para o PR #${PR}..."
          curl -sSL \
            -X POST "$AGENT_URL" \
            -H "Content-Type: application/json" \
            -d '{
                  "repo_url": "'"${REPO}"'",
                  "pr_number": '"${PR}"',
                  "github_token": "'"${TOKEN}"'"
                }' \
          | tee pr_agent_response.json

      - name: Mostrar resposta do PRâ€‘Agent
        run: cat pr_agent_response.json
